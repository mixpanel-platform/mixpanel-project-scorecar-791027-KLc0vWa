<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="results"></div>
    
    <script id="jql">
function main() {
  return People()
  
  /* Map function for re-calibrating grades */
  .map(function(proj){
    // Obtain current grades
    var project_grade_info = {
      'previous_event_grade':proj.properties['Project Grade (events)'],
      'previous_overall_project_grade':proj.properties['Project Grade (overall)'],
      'previous_people_grade':proj.properties['Project Grade (people)']
    };

    // Calculate new event score
    var event_sum = 0;
    if(proj.properties['Event Count (unique)'] > 7 && proj.properties['Event Count (unique)']< 200){
      event_sum += 3;
    }
    if(proj.properties['Avg Event Similarity'] <30){
      event_sum += 0.5;
    }
    if(proj.properties['Prop Count (unique)'] > 6 && proj.properties['Prop Count (unique)']< 200){
      event_sum += 3;
    }
    if(proj.properties['Prop/Event Ratio'] > 4){
      event_sum += 1;
    }
    if(proj.properties['Super Prop Count (unique)'] > 0){
      event_sum += 0.5;
    }
    
    // Calculate new event grade
    if(event_sum > 5){
      project_grade_info.event_grade = "A";
    }
    else if(event_sum <=5 && event_sum >=4){
      project_grade_info.event_grade = "B";
    }
    else if(event_sum < 4 && event_sum >=2){
      project_grade_info.event_grade = "C";
    }
    else if(event_sum < 2){
      project_grade_info.event_grade = "D";
    }
    return project_grade_info;
  })};
    </script>
    
    <script>
    var script = $('#jql').html();
    script = $.trim(script);
    console.log(script);
    var params = {};
    MP.api.jql(script,params).done(function(results) {
      console.log(results);
      results = processResults(results);
      console.log(results);
      //document.getElementById('results').innerHTML += results;
    });
    
    
    function processResults(projects){
      var return_obj = {
        'D_total':0,
        'C_total':0,
        'B_total':0,
        'A_total':0,
        'D_previous':0,
        'C_previous':0,
        'B_previous':0,
        'A_previous':0,
        'previous_total':0,
        'current_total':0
      };
      for(var i = 0; i < projects.length; i++){
        // Only sum if the previous event grade is set 
        if(projects[i].previous_event_grade != "(no grade)"){
          // Sum up new grades
          if(projects[i].event_grade == "A"){
            return_obj.A_total++;
          }else if(projects[i].event_grade == "B"){
            return_obj.B_total++;
          }else if(projects[i].event_grade == "C"){
            return_obj.C_total++;
          }else if(projects[i].event_grade == "D"){
            return_obj.D_total++;
          }
          // Sum up old grades
          if(projects[i].previous_event_grade == "A"){
            return_obj.A_previous++;
          }else if(projects[i].previous_event_grade == "B"){
            return_obj.B_previous++;
          }else if(projects[i].previous_event_grade == "C"){
            return_obj.C_previous++;
          }else if(projects[i].previous_event_grade == "D"){
            return_obj.D_previous++;
          }
        }
      }
      return_obj.previous_total = return_obj.D_previous + return_obj.C_previous + return_obj.B_previous + return_obj.A_previous;
      return_obj.current_total = return_obj.D_total + return_obj.C_total + return_obj.B_total + return_obj.A_total;
      return return_obj;
    }
    </script>

  </body>
</html>
